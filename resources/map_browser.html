<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <title>Browse DK maps</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        input {
            all: unset;
        }

        input:focus {
            outline: unset;
            border-bottom: 1px solid rgb(244, 244, 244);
        }

        *,
        input {
            font-size: 105%;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        }

        h1 {
            font-size: 110%;
        }

        body {
            /* background-color: rgb(30, 30, 30); */
            background: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD//gATQ3JlYXRlZCB3aXRoIEdJTVD/2wBDAA0JCgsKCA0LCgsODg0PEyAVExISEyccHhcgLikxMC4pLSwzOko+MzZGNywtQFdBRkxOUlNSMj5aYVpQYEpRUk//2wBDAQ4ODhMREyYVFSZPNS01T09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0//wgARCAFiAUUDAREAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBv/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB53FgBQWUASwAUgKIAqwApALEtBmzIsAsss1LZc2CkBQDUsJZZRLAAKQsAoIULLLCgxYJRBZaCyyyAAApqWBFWUCEsFIVULEqxKAJYLLLICFBSyklCAAoLAlWAC0gCFAlliVRKJYBZZYICgAsssAgKAACxTIoWUkoWWWWJQsFJKAsssEKWUCWAAQFAAANSjNllAAlgsSgAAAAIUsoEsAAAApACxVgACACVYlAAAAAQoLKJZChbEsstIAkqyrEopAkoCyklAACyiWWUSwCFUgFlAlllAFIAAUgSUAAAALKsSyyygCWCyywWUASyxKsoAFALBc3MFAACxKFEpAWWWUSyFBCgsAoJVhSJVgCams2UiSgAALAKABLLLSGbAAKAAalhSFBCWDcsICWAAAWAUCkJYLKJZKQAKAWWg1GaEKZssalzRKubAAALBQABLLBZYIACgsVaQpZRELLIUiFllgSgABYCoWCrEsQKAgKAWXRAWJWpRElWXGsiygUzYAAKQApAWJVlIWWQFALLQQ1EoalzZAkqxKstISyFAAAAALEqwCywQoBZaCFBCghLABZaQzYBQAAAACiUhZYAALKBQWXNgEssssAAsssgBQAUgABYALLAABZQBTcuUzqJZYAIUFllkABQAACwBKFiUBCgsoA1BSY1LEoWJUAKAQAoAAKQFiVYBZYALBQKAQpmywXNgAFKsQAAAAWJQsSrAEoCwWgAgBSAlkAABohCgFllliVYlAAAWVYiVZaQFIAELZZZmyWAWWWF3myyAFBZQBLABQQoEqxBSFABCikM2QWCyilllkKQFALKFiCklACgSghVgSgElWUZsEsLYGpRLIAACll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') repeat;
            color: #eee;
            margin: 2em;
        }

        table {
            color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
        }

        table td {
            padding: 6px 9px;
            border: 1px solid rgb(44, 44, 44);
            transition: 0.5s all;
        }

        tr {
            cursor: pointer;
        }

        tr.active-cursor td {
            background-color: rgb(53, 1, 1);
            background-color: #b83810;
        }

        input {
            margin-bottom: 1em;
            /* background-color: rgb(30, 30, 30); */
            border-bottom: 2px solid rgb(244, 244, 244);
            padding: 6px 3px;
        }
    </style>
</head>

<body>

    <h1>Dungeon Keeper map script browser</h1>
    <input placeholder="Search..." type="text" id="maps-search">
    <table id="maps-table"></table>

    <script>
        (function (api) {
            const MSG_TYPES = {
                build: "build"
            };
            const ELEMS = {
                mapsTable: document.getElementById("maps-table"),
                mapsSearch: document.getElementById("maps-search")
            };
            const ACTIVE_CURSOR_CLASS = "active-cursor";
            let maps = [];
            let filteredMaps = [];
            let filteredRows = [];
            let cursorIndex = -1;

            function handleChosenMap(map) {
                if (map) { api.postMessage(map); }
            }

            function handleSearchChange(searchFilter) {
                rebuild(searchFilter);
            }

            function handleKeyUpDown(direction) {
                let newVal = cursorIndex + direction;
                if (newVal < 0) { newVal = filteredMaps.length - 1; }
                if (newVal >= filteredMaps.length) { newVal = 0; }
                changeCursorIndex(newVal);
            }

            function changeCursorIndex(newVal) {
                if (filteredRows[cursorIndex]) {
                    filteredRows[cursorIndex].classList.remove(ACTIVE_CURSOR_CLASS);
                }
                if (filteredRows[newVal]) {
                    filteredRows[newVal].classList.add(ACTIVE_CURSOR_CLASS);
                }
                cursorIndex = newVal;
            }

            function handleEnter() {
                handleChosenMap(filteredMaps[cursorIndex]);
            }

            function rebuild(searchFilter) {
                function buildTableRow(mapName, mapTitle) {
                    const cell1 = document.createElement("TD");
                    const cell2 = document.createElement("TD");
                    const row = document.createElement("TR");
                    cell1.innerText = mapName.replace(/\.txt/i, "");
                    cell2.innerText = mapTitle;
                    row.appendChild(cell1);
                    row.appendChild(cell2);
                    return row;
                }
                ELEMS.mapsTable.innerHTML = "";
                cursorIndex = 0;
                filteredMaps = [];
                filteredRows = [];
                const fragment = new DocumentFragment;
                maps.forEach((map) => {
                    if (
                        !searchFilter
                        || map.name.toLowerCase().includes(searchFilter)
                        || map.title.toLowerCase().includes(searchFilter)
                    ) {
                        const newRow = buildTableRow(map.name, map.title);
                        const newRowIndex = filteredMaps.length;
                        fragment.appendChild(newRow);
                        newRow.addEventListener("click", function () {
                            handleChosenMap(map);
                        });

                        newRow.addEventListener("mouseenter", () => { changeCursorIndex(newRowIndex); });
                        filteredMaps.push(map);
                        filteredRows.push(newRow);
                    }
                });
                ELEMS.mapsTable.appendChild(fragment);
                changeCursorIndex(-1);
            }

            ELEMS.mapsSearch.addEventListener("keyup", function (e) {
                const upDownKeys = {
                    ArrowDown: 1,
                    ArrowUp: -1,
                };
                if (upDownKeys[e.key]) {
                    handleKeyUpDown(upDownKeys[e.key]);
                } else if (e.key === "Enter") {
                    handleEnter();
                } else {
                    handleSearchChange(e.target.value.toLowerCase());
                }
            })
            window.addEventListener("message", function (e) {
                const msg = e.data;
                if (msg.type === MSG_TYPES.build) {
                    maps = msg.maps;
                    rebuild("");
                }
            });
            // html autofocus is blocked, do this in js
            setTimeout(() => ELEMS.mapsSearch.focus());
        })(acquireVsCodeApi())
    </script>
</body>

</html>